<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spotify Redirect - Authorization Completed</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; padding: 24px; max-width: 720px; margin: auto; }
    .card { border: 1px solid #eee; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    h1 { margin-top: 0; }
    .ok { color: #0a0; }
    .warn { color: #b85; }
    button { background:#1DB954; color:white; border:none; padding:12px 18px; font-size:16px; border-radius:6px; cursor:pointer; }
    a { color:#1DB954 }
  </style>
</head>
<body>
  <div class="card">
    <h1>Spotify authorization</h1>
    <p id="status">Preparing redirect...</p>
    <div id="progress" style="margin-top:16px;">
      <p id="countdown">Redirecting in <span id="secs">3</span> seconds...</p>
      <p>If you are not redirected automatically you can click the link that will appear below.</p>
    </div>
    <div id="manual" style="margin-top:16px; display:none">
      <p class="warn">Automatic redirect is not available. Use the link below to continue.</p>
      <p><a id="openAuth" href="#">Open authorization URL</a></p>
    </div>
    <hr />
    <small>This page helps forward the Spotify authorization request â€” no passwords or tokens are stored here.</small>
  </div>

<script>
  (function(){
    const params = new URLSearchParams(window.location.search);
    const providedAuthUrl = params.get('auth_url');
    const clientId = params.get('client_id');
    const redirectUri = params.get('redirect_uri');
    const scopeParam = params.get('scope');
    const state = params.get('state') || '';
    const status = document.getElementById('status');
    const openAuth = document.getElementById('openAuth');
    const manual = document.getElementById('manual');
    const secsEl = document.getElementById('secs');

    // Default scopes used by the app
    const defaultScope = 'user-library-read user-read-playback-state user-modify-playback-state playlist-read-private';

    function buildAuthUrlFromParts(clientId, redirectUri, scope, state) {
      const base = 'https://accounts.spotify.com/authorize';
      const params = new URLSearchParams();
      params.set('client_id', clientId);
      params.set('response_type', 'code');
      params.set('redirect_uri', redirectUri);
      params.set('scope', scope);
      if (state) params.set('state', state);
      params.set('show_dialog', 'true');
      return base + '?' + params.toString();
    }

    // Determine the target auth URL
    let targetAuthUrl = null;
    if (providedAuthUrl) {
      targetAuthUrl = providedAuthUrl;
    } else if (clientId && redirectUri) {
      const scope = scopeParam || defaultScope;
      targetAuthUrl = buildAuthUrlFromParts(clientId, redirectUri, scope, state);
    }

    if (!targetAuthUrl) {
      status.innerHTML = '<strong class="warn">No authorization information found.</strong>';
      manual.style.display = 'block';
      openAuth.textContent = 'Return to app';
      openAuth.href = '/';
      return;
    }

    // Try automatic redirect with a short countdown and a manual fallback link
    openAuth.href = targetAuthUrl;
    openAuth.textContent = targetAuthUrl;
    let secs = 3;
    const interval = setInterval(() => {
      secs -= 1;
      secsEl.textContent = String(secs);
      if (secs <= 0) {
        clearInterval(interval);
        // perform the redirect
        window.location.href = targetAuthUrl;
      }
    }, 1000);

    // Show the manual link in case automatic redirect is blocked
    manual.style.display = 'block';
  })();
</script>
</body>
</html>
